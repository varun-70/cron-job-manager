name: Multi-Project Executor

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Which project ID to run? (e.g., 01)'
        required: true
        default: '01'

jobs:
  execute-private-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Project Link
        id: vars
        env:
          REPO_MAP: ${{ secrets.PRIVATE_REPO_URL }}
          # Use input ID if manual, otherwise default to '01' for schedule
          ID: ${{ github.event.inputs.project_id || '01' }}
        run: |
            # Use a heredoc to safely pass the JSON to jq
            PICKED_URL=$(jq -r --arg ID "$ID" '.[$ID]' <<EOF
            $REPO_MAP
            EOF
            )
          
            if [ "$PICKED_URL" == "null" ] || [ -z "$PICKED_URL" ]; then
                echo "::error::Project ID '$ID' not found in REPO_MAP or JSON is invalid."
                exit 1
            fi

            # Mask the URL so it doesn't show in logs
            echo "::add-mask::$PICKED_URL"
            echo "target_url=$PICKED_URL" >> $GITHUB_OUTPUT

      - name: Clone and Run
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          TARGET_URL: ${{ steps.vars.outputs.target_url }}
          KITE_USER: ${{ secrets.KITE_USER_ID }}
          KITE_TOKEN: ${{ secrets.KITE_ENCTOKEN }}
        run: |
          # Construct authenticated URL
          AUTH_URL=$(echo $TARGET_URL | sed "s/https:\/\//https:\/\/x-access-token:${GH_TOKEN}@/")
          
          # Clone quietly and move into workspace
          git clone --depth 1 "$AUTH_URL" workspace -q
          cd workspace
          
          # Standard execution steps
          pip install -r requirements.txt --quiet
          KITE_USER_ID=$KITE_USER KITE_ENCTOKEN=$KITE_TOKEN python fetch_stock_data.py --silent > /dev/null 2>&1
          
          # Move artifacts out before workspace is wiped
          mv *.csv ../ 2>/dev/null || true

      - name: Save Data
        uses: actions/upload-artifact@v4
        with:
          name: output-data-${{ github.run_id }}
          path: "*.csv"
          retention-days: 1
